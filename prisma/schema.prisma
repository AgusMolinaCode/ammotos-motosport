// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Turn14 Brand Model
model Brand {
  id               String    @id
  name             String
  dropship         Boolean
  logo             String?
  aaia             String[]  // Array of AAIA codes
  pricegroups      Json      // Store as JSON for flexibility
  detailsFetched   Boolean   @default(false) // Track if full details cached
  detailsFetchedAt DateTime? // Audit trail for debugging
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([name])
  @@index([detailsFetched])
  @@map("brands")
}

// Sync Control - tracks when last sync occurred
model SyncControl {
  id        String   @id @default(cuid())
  entity    String   @unique // e.g., "brands"
  lastSync  DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sync_control")
}

// Turn14 Product Model (cached on-demand)
model Product {
  id                String   @id // Turn14 item_id (puede contener letras, ej: "13504G")
  brandId           Int      // Brand ID from Turn14
  brandName         String
  productName       String
  partNumber        String   // Turn14 internal part number
  mfrPartNumber     String   // Manufacturer part number
  partDescription   String?
  category          String
  subcategory       String
  priceGroupId      Int
  priceGroup        String
  active            Boolean
  regularStock      Boolean
  clearanceItem     Boolean  @default(false) // Item en liquidación
  thumbnail         String?  // URL de la imagen
  dimensions        Json     // Array de Dimensions
  warehouseAvailability Json // Array de WarehouseAvailability
  apiPage           Int?     // Página de API Turn14 de donde proviene (para sparse cache)

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([brandId])
  @@index([partNumber])
  @@index([mfrPartNumber])
  @@index([brandId, apiPage]) // Para queries eficientes por página
  // Índices compuestos para filtrado optimizado
  @@index([brandId, category])
  @@index([brandId, subcategory])
  @@index([brandId, productName])
  @@index([brandId, category, subcategory])
  @@index([brandId, category, apiPage])
  @@map("products")
}

// Control de páginas cacheadas por brand
model ProductPageCache {
  id            String   @id @default(cuid())
  brandId       Int
  page          Int
  totalApiPages Int?     // Total de páginas reportado por la API Turn14 (para detectar nuevas páginas)
  cachedAt      DateTime @default(now())

  @@unique([brandId, page])
  @@index([brandId])
  @@map("product_page_cache")
}

// Turn14 Product Pricing Model (cached on-demand)
model ProductPrice {
  id              String   @id @default(cuid())
  productId       String   @unique // Foreign key to Product.id
  purchaseCost    Float    // Distributor cost (internal use)
  hasMap          Boolean  // Has MAP pricing policy
  canPurchase     Boolean  // Available for purchase
  pricelists      Json     // Store raw pricelists array from API
  mapPrice        Float?   // Extracted MAP price for efficient queries

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([productId])
  @@index([hasMap])
  @@map("product_prices")
}

// Control de páginas de precios cacheadas por brand
model PricePageCache {
  id            String   @id @default(cuid())
  brandId       Int
  page          Int
  totalApiPages Int?     // Total de páginas reportado por la API Turn14 (para detectar nuevas páginas)
  cachedAt      DateTime @default(now())

  @@unique([brandId, page])
  @@index([brandId])
  @@map("price_page_cache")
}

// Categorías únicas por marca (extraídas de productos)
model BrandCategory {
  id          String   @id @default(cuid())
  brandId     Int
  category    String   // Categoría en inglés (desde API)
  categoryEs  String   // Traducción al español

  createdAt   DateTime @default(now())

  @@unique([brandId, category])
  @@index([brandId])
  @@map("brand_categories")
}

// Subcategorías únicas por marca (extraídas de productos)
model BrandSubcategory {
  id             String   @id @default(cuid())
  brandId        Int
  subcategory    String   // Subcategoría en inglés (desde API)
  subcategoryEs  String   @default("") // Traducción al español

  createdAt      DateTime @default(now())

  @@unique([brandId, subcategory])
  @@index([brandId])
  @@map("brand_subcategories")
}

// Product Names únicos por marca (extraídas de productos)
model BrandProductName {
  id           String   @id @default(cuid())
  brandId      Int
  productName  String   // Product Name desde API

  createdAt    DateTime @default(now())

  @@unique([brandId, productName])
  @@index([brandId])
  @@map("brand_product_names")
}

// Turn14 Inventory Model (cached by brand with TTL)
model BrandInventory {
  id              String   @id @default(cuid())
  brandId         Int
  itemId          String   // Product/Item ID from Turn14
  totalStock      Int      // Calculated total stock across all warehouses
  inventory       Json     // Warehouse inventory map: {"01": 5, "02": 10, ...}
  manufacturerStock Int?   // Stock at manufacturer (optional)
  manufacturerEsd String?  // Estimated Ship Date from manufacturer (optional)

  // Cache metadata
  cachedAt        DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([brandId, itemId])
  @@index([brandId])
  @@index([itemId])
  @@index([cachedAt]) // For TTL queries
  @@map("brand_inventory")
}

// Control de caché de inventario por brand
model InventoryCache {
  id        String   @id @default(cuid())
  brandId   Int      @unique
  cachedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([brandId])
  @@index([cachedAt]) // For TTL queries
  @@map("inventory_cache")
}
